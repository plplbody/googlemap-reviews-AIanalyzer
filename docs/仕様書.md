# 🚀 プロジェクト仕様書：Google Map口コミ高度分析アプリケーション

あなたは世界トップクラスのシニア・フルスタックエンジニアです。以下の「プロジェクト定義書」に基づき、アプリケーションの開発を継続してください。

このドキュメントは本プロジェクトの **SSOT (Single Source of Truth)** です。
詳細な設計情報は `docs/` ディレクトリ内の各ドキュメントを参照してください。

-----

## 1. ドキュメント体系

本プロジェクトの設計情報は以下のドキュメントに分割・管理されています。

| ドキュメント | パス | 内容 |
| :--- | :--- | :--- |
| **AI評価ロジック仕様書** | [`docs/ai_logic.md`](./docs/ai_logic.md) | **最重要**。AI分析スコア算出、フィルタリング、プロンプト設計の詳細。 |
| **システムアーキテクチャ** | [`docs/architecture.md`](./docs/architecture.md) | Next.js, Firebase, Cloud Tasks等の構成と環境戦略。 |
| **データモデル設計書** | [`docs/data_model.md`](./docs/data_model.md) | Firestore Schema (Place Interface) の定義。 |

-----

## 2. アプリケーション定義

実装済み機能に基づき、以下の仕様を定義する。

1.  **AI分析スコア (AI Analysis Score)**
    *   AIが口コミの内容を精査し、信頼できる情報のみに基づいて算出したスコア（旧称: True Score）。
    *   **情報源の拡充**: Google口コミに加え、HotPepperの店舗情報（個室有無、子供連れ可否など）をプロンプトに注入し、特に利用シーン判定の精度を向上させる。
    *   **透明性**: Google Places APIの仕様に基づき、「最も関連性の高い上位5件」のレビューを分析対象とする。この制約をUI上で明示する。
    *   Googleスコアとの乖離がある場合、その理由（Gap Reason）を提示する。

2.  **多軸評価 (Axis Analysis)**
    *   「味・品質」「接客・サービス」「雰囲気」「コスパ」の4軸で5段階評価。
    *   **レーダーチャート**: 4軸のバランスを可視化する。
    *   **バッジ認定**: 特定のスコア（例: 味4.5以上）で「美食家認定」等のバッジを付与する。
    *   各軸ごとに「評価されている点 (Pros)」と「懸念されている点 (Cons)」を詳しくリストアップする。

3.  **パーソナライズスコア (Personalized Match Score)**
    *   ユーザーが重視するポイント（味、接客など最大2つ）を選択可能。
    *   選択された軸の重み付けを増やし（x3）、ユーザーごとの「あなたへのマッチ度」をリアルタイムで算出・表示する。

4.  **利用シーン判定 (Usage Scenarios)**
    *   以下の5つのシーンへの適性をスコアリングする。
        *   **ビジネス**（接待・会食）
        *   **デート**（記念日・カップル）
        *   **お一人様**（ランチ・サク飲み）
        *   **ファミリー**（お子様連れ）
        *   **団体利用**（宴会・飲み会） [NEW]
    *   **根拠の提示**: シーンへの適性理由を要約した「シーン分析コメント」を表示する。

5.  **詳細情報分析 (Detailed Information)** [NEW]
    *   Google Mapsからは判別しにくい情報を構造化して表示する。
    *   **決済方法**: クレジットカード、電子マネー等の対応状況。
    *   **サービス**: デリバリー、テイクアウト、個室有無、予約可否。
    *   **アメニティ**: トイレ、子供連れ対応、バリアフリー情報。
    *   **価格帯**: 具体的な価格レンジ（例: ¥3,000〜¥10,000）と「高級」「お手頃」などのラベル表示。

6.  **外部データ連携 (External Data Integration)** [NEW]
    *   **HotPepper Web Service (Recruit)**: 店舗情報の拡充と高解像度画像の取得に使用。
    *   **突合ロジック (Matching Logic)**:
        1.  **電話番号優先 (High Accuracy)**: Google Placesの電話番号と完全一致する店舗を検索。
        2.  **店名フォールバック**: 電話番号がない、またはヒットしない場合のみ、店名で検索を行う（同名他店のリスクを許容）。
    *   **表示項目**: 店舗画像（サムネイル）、最寄駅、アクセス情報、平均予算、クレジット表記 ("Powered by HotPepper")。
    *   **クレジット遵守**: リクルート社のAPI利用規約に基づき、データ使用箇所にはクレジットを明記する。

    *   **HeartRails Express API**: 最寄駅情報の取得に使用。
    *   **用途**: 店舗の緯度経度から最寄駅と距離を取得し、アクセス情報として表示する。
    *   **表示形式**: "駅名 距離"（例: 六本木駅 350m）。
    *   **クレジット**: HeartRails Expressへのリンク等を適切に配置する。

7.  **データの鮮度と自動更新 (Data Freshness)**
    *   **有効期限**: 分析データの有効期限は **30日間** とする。
    *   **自動更新**: ユーザーが詳細ページにアクセスした際、データが30日以上古い場合は自動的に再分析（口コミ再取得＋AI分析）を実行する。
    *   **UI表示**: データの「最終更新日」をヘッダーに明示する。


-----

## 3. 技術スタック概要

詳細は [`docs/architecture.md`](./docs/architecture.md) を参照。

*   **Frontend/Backend**: Next.js 14+ (App Router)
*   **Styling**: Tailwind CSS + Lucide React
*   **Database**: Google Cloud Firestore (Cache & Analysis storage)
*   **AI**: Vertex AI (Gemini 2.0 Flash)
*   **Infrastructure**: Google Cloud Run + Cloud Tasks

-----

## 4. 開発者への指示（Instructions）

### 開発フロー
1.  **設計確認**: `docs/` 以下の関連ドキュメントを確認する。
2.  **実装**: コードを変更する際は、必ず日本語でコメントを記述する。
3.  **検証**: ローカル環境 (Docker Compose) で動作確認を行う。

### 重要なルール
*   **AIロジックの変更**: `docs/ai_logic.md` の更新を必須とする。
*   **日本語徹底**: ソースコード内のコメント、コミットメッセージ、ドキュメントは全て日本語で記述する。

-----

## 5. コスト最適化戦略 (Cost Optimization)

**ID先行取得による検索コスト削減**
Google Places APIのコストを最小化するため、以下の検索フローを採用する。

1.  **ID検索 (Free)**: まず `Text Search (ID Only)` を実行し、Place IDのリストのみを取得する（コスト: $0）。
2.  **キャッシュ判定**: 取得したIDリストに対し、Firestore上のキャッシュ有効性を確認する。
3.  **条件付きデータ取得**:
    *   **全員キャッシュあり**: Firestoreのデータを返却（コスト: $0）。
    *   **欠損あり**: 欠損がある場合のみ、元の検索クエリで `Text Search (Pro)` を実行し、全件の最新データを取得・保存する（コスト: 通常通り）。

これにより、2回目以降の検索（キャッシュヒット時）のAPIコストを完全にゼロにする。