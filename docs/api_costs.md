# API利用料金・コスト試算

本アプリケーションで使用している主要なAPIサービスの料金体系と、想定されるランニングコストについてまとめます。
※料金は2025年12月時点の目安であり、Google Cloudの価格改定や為替レートにより変動する可能性があります。

## 1. 一覧画面でのAIスコア表示機能（確定版）

ユーザーとの協議により決定した「一覧検索時に詳細情報を一括取得し、全件AI分析を行う」アーキテクチャのコスト試算です。
**Google Places API (New) のリクエスト単位課金**を活用し、コストを最小限に抑えます。

### アーキテクチャ

1.  **一括詳細取得**: `Text Search (Enterprise)` を使用し、1回のリクエストで20件分の口コミ・詳細情報を取得します。
2.  **非同期AI分析**: 取得したデータをDBに保存し、バックグラウンドで全件に対してGemini分析を実行します。
3.  **リアルタイム表示**: ユーザー画面には分析が完了したものから順次スコアが表示されます。

### 1検索あたりのコスト試算 (20件表示時)

**前提**: ユーザーが検索ボタンを1回押し、20件の結果が表示される場合。

| 項目 | 課金単位 | 単価 | 数量 | コスト |
| :--- | :--- | :--- | :--- | :--- |
| **Google Places API** | Text Search (Enterprise) リクエスト | $35.00 / 1000回 | 1回 | **$0.035** |
| **Vertex AI (Gemini)** | 1.5 Flash (入力+出力) | ~$0.0005 / 件 | 20件 | **$0.010** |

**合計: 1回の検索あたり 約 $0.045 (約 6.8円)**

※ $1 = 150円換算
※ 全てが「初見の店舗」である場合の試算です。
※ 既にＤＢに分析データがある店舗が含まれる場合は、AIコストがさらに下がります（APIコストは検索リクエスト単位のため変わりません）。

### 結論
この方式は、以前検討した「都度詳細取得（B案：約100円）」と比較して **約1/15 のコスト** で実現可能です。
ユーザー体験（一覧で即スコア確認）とコストパフォーマンスを両立できる最適なプランです。

---

## 2. 検索実行件数変更のコスト試算 (40件取得)

### 変更内容
ユーザーからの要望により、1回の検索で取得する件数を **20件 → 40件** に増加させます。
技術的には、Google Places APIに対して **2連続でリクエスト (PageToken駆動)** を行うことで実現します。

### 1検索あたりのコスト試算 (40件表示時)

**前提**: ユーザーが検索ボタンを1回押し、40件の結果が表示される場合。

| 項目 | 課金単位 | 単価 | 数量 | コスト |
| :--- | :--- | :--- | :--- | :--- |
| **Google Places API** | Text Search (Enterprise) リクエスト | $35.00 / 1000回 | **2回** | **$0.070** |
| **Vertex AI (Gemini)** | 1.5 Flash (入力+出力) | ~$0.0005 / 件 | **40件** | **$0.020** |

**合計: 1回の検索あたり 約 $0.090 (約 13.5円)**

*   単純に20件時の **2倍** のコストとなります。
*   依然として画像を表示しない限りは低コスト運用が可能ですが、無駄な呼び出し（40件も見ないケース）が増えるリスクはあります。
*   まずはこの設定で運用し、コスト増が見合わない場合は「Load More」ボタン方式（オンデマンド20件追加）への切り戻しを検討します。

---

## 2. パーソナライズ機能の追加コスト (New)

ユーザー傾向分析とレコメンド機能の実装に伴う追加コストの試算です。

### A. 特徴タグ抽出 (Feature Extraction)
AI分析時に、「静か」「インスタ映え」などのタグを抽出します。
*   **コスト増目安**: 出力トークンが約1.2倍に増加。
*   **金額**: 1店舗あたり **+$0.0001 (約0.015円)**
*   **影響**: ほぼ無視できるレベルの微増です。

### B. ユーザープロファイル分析 (Profile Analysis)
ユーザーのGood/Bad履歴が溜まったタイミング（例: 10件ごと）で、バックグラウンドでユーザーの傾向ベクトルをAIが再計算する場合。
*   **Gemini 1.5 Flash**: 入力(履歴10件分) + 出力(分析結果)
*   **単価**: 1回あたり **約 $0.002 (約0.3円)**
*   **頻度**: 頻繁ではないため、月額コストへの影響は軽微です。

### C. 有料会員機能としての提案
レコメンド機能自体にかかる計算コスト（DB読み込み等）は低いですが、付加価値が高いため、以下のようなモデルが考えられます。

| プラン | 機能 | コスト（開発側） |
| :--- | :--- | :--- |
| **Free (無料)** | 検索・AIスコア表示・マイリスト保存・履歴閲覧 | 低 |
| **Premium (有料)** | **AI傾向分析レポート** (レーダーチャート・タグ)<br>**あなたへのおすすめ順** ソート<br>広告非表示 | 低〜中 |

技術的なコスト増は少ないため、**Premiumプランの利益率は非常に高く**なります。

---

## 3. 追加仕様のコスト試算：60件検索＋画像表示

「検索結果を60件取得し、かつヘッダー画像を表示する」場合のコスト試算です。
結論から言うと、**画像表示 (Place Photo SKU)** が支配的なコスト要因となり、**約12倍（85円/回）** にコストが跳ね上がります。

### 試算条件
*   **検索件数**: 60件 (20件 × 3回リクエスト)
*   **画像取得**: 60件すべてでヘッダー画像を表示
*   **AI分析**: 60件すべてで分析実行

### コスト比較

| 項目 | 現行 (20件・画像なし) | **新仕様 (60件・画像あり)** | 備考 |
| :--- | :--- | :--- | :--- |
| **Search API** | $0.035 (1回) | **$0.105** (3回) | リクエスト数に比例して3倍 |
| **AI Analyze** | $0.010 (20件) | **$0.030** (60件) | 件数に比例して3倍 |
| **Photo API** | $0 (なし) | **$0.420** (60枚) | **[要注意]** $7.00/1000回 × 60 |
| **合計 (USD)** | **$0.045** | **$0.555** | |
| **合計 (円)** | **約 6.8円** | **約 83.3円** | 1検索あたり |

### 分析と提言
1.  **Photo APIが高コスト**: 画像を表示するだけで、検索APIの4倍以上のコスト ($0.42) がかかります。60件すべてで画像をロードするのは危険です。
2.  **遅延読み込み (Lazy Load)**: ファーストビューの数件のみ画像を取得し、スクロール時はプレースホルダーにする等の対策が必須です。
3.  **キャッシュ戦略**: 画像URL（有効期限あり）または画像バイナリのキャッシュ戦略を検討する必要がありますが、Google規約上、画像バイナリの永続保存は制限（キャッシュ不可）されているケースが多く、注意が必要です。

---

## 3. その他のコスト情報

### Google Vertex AI (Gemini)
*   **Gemini 1.5 Flash**: 入力 ~$0.075 / 1Mトークン, 出力 ~$0.30 / 1Mトークン
*   **Gemini 1.5 Pro**: 入力 ~$3.50 / 1Mトークン, 出力 ~$10.50 / 1Mトークン

### Firebase (Firestore)
*   **読み取り/書き込み**: 通常利用の範囲内であれば少額（検索頻度によるが、数円〜数十円/月 程度からスタート）。
