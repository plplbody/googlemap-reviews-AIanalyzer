# 🚀 プロジェクト仕様書：Google Map口コミ高度分析アプリケーション

あなたは世界トップクラスのシニア・フルスタックエンジニアです。以下の「プロジェクト定義書」に基づき、アプリケーションの開発を継続してください。

このドキュメントは本プロジェクトの **SSOT (Single Source of Truth)** です。
詳細な設計情報は `docs/` ディレクトリ内の各ドキュメントを参照してください。

-----

## 1. ドキュメント体系

本プロジェクトの設計情報は以下のドキュメントに分割・管理されています。

| ドキュメント | パス | 内容 |
| :--- | :--- | :--- |
| **AI評価ロジック仕様書** | [`docs/ai_logic.md`](./docs/ai_logic.md) | **最重要**。AI分析スコア算出、フィルタリング、プロンプト設計の詳細。 |
| **システムアーキテクチャ** | [`docs/architecture.md`](./docs/architecture.md) | Next.js, Firebase, Cloud Tasks等の構成と環境戦略。 |
| **データモデル設計書** | [`docs/data_model.md`](./docs/data_model.md) | Firestore Schema (Place Interface) の定義。 |

-----

## 2. アプリケーション定義

1.  **AI分析スコア (AI Analysis Score)**
    *   AIが口コミの内容を精査し、信頼できる情報のみに基づいて算出したスコア（旧称: True Score）。
    *   **透明性**: Google Places APIの仕様に基づき、「最も関連性の高い上位5件」のレビューを分析対象とする。この制約をUI上で明示する。
    *   Googleスコアとの乖離がある場合、その理由（Gap Reason）を提示する。
2.  **多軸評価 (Axis Analysis)**
    *   「味・品質」「接客・サービス」「雰囲気」「コスパ」の4軸で評価。
    *   各軸ごとに「評価されている点 (Pros)」と「懸念されている点 (Cons)」をマトリクス表示する。
3.  **利用シーン判定 (Usage Scenarios)**
    *   「ビジネス」「デート」「お一人様」「ファミリー」への適性をスコアリング。
    *   **根拠の提示**: 各シーンへの適性理由を要約した「シーン分析コメント」を表示する。
4.  **データの鮮度と自動更新 (Data Freshness)**
    *   **有効期限**: 分析データの有効期限は **30日間** とする。
    *   **自動更新**: ユーザーが詳細ページにアクセスした際、データが30日以上古い場合は自動的に再分析（口コミ再取得＋AI分析）を実行する。
    *   **UI表示**: データの「最終更新日」をヘッダーに明示する。

-----

## 3. 技術スタック概要

詳細は [`docs/architecture.md`](./docs/architecture.md) を参照。

*   **Frontend/Backend**: Next.js 14+ (App Router)
*   **Database**: Google Cloud Firestore
*   **AI**: Vertex AI (Gemini 2.0 Flash)
*   **Infrastructure**: Google Cloud Run + Cloud Tasks

-----

## 4. 開発者への指示（Instructions）

### 開発フロー
1.  **設計確認**: `docs/` 以下の関連ドキュメントを確認する。
2.  **実装**: コードを変更する際は、必ず日本語でコメントを記述する。
3.  **検証**: ローカル環境 (Docker Compose) で動作確認を行う。

### 重要なルール
*   **AIロジックの変更**: `docs/ai_logic.md` の更新を必須とする。
*   **日本語徹底**: ソースコード内のコメント、コミットメッセージ、ドキュメントは全て日本語で記述する。

-----

## 5. コスト最適化戦略 (Cost Optimization)

**ID先行取得による検索コスト削減**
Google Places APIのコストを最小化するため、以下の検索フローを採用する。

1.  **ID検索 (Free)**: まず `Text Search (ID Only)` を実行し、Place IDのリストのみを取得する（コスト: $0）。
2.  **キャッシュ判定**: 取得したIDリストに対し、Firestore上のキャッシュ有効性を確認する。
3.  **条件付きデータ取得**:
    *   **全員キャッシュあり**: Firestoreのデータを返却（コスト: $0）。
    *   **欠損あり**: 欠損がある場合のみ、元の検索クエリで `Text Search (Pro)` を実行し、全件の最新データを取得・保存する（コスト: 通常通り）。

これにより、2回目以降の検索（キャッシュヒット時）のAPIコストを完全にゼロにする。